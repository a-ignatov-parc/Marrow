/**
 * Marrow - v1.3.6-147 (build date: 01/05/2013)
 * Sandbox webapp loading framework with conditional recipes
 * Copyright (c) 2013 Anton Ignatov <a.ignatov@parcsis.org>
 */
(function(t,e){function n(){return(0|65536*(1+Math.random())).toString(16).substring(1)}function i(){return n()+n()+"-"+n()+"-"+n()+"-"+n()+"-"+n()+n()+n()}e.LocalStorage=window.Store=function(t){this.name=t;var e=this.localStorage().getItem(this.name);this.records=e&&e.split(",")||[]},t.extend(e.LocalStorage.prototype,{save:function(){this.localStorage().setItem(this.name,this.records.join(","))},create:function(t){return t.id||(t.id=i(),t.set(t.idAttribute,t.id)),this.localStorage().setItem(this.name+"-"+t.id,JSON.stringify(t)),this.records.push(""+t.id),this.save(),t.toJSON()},update:function(e){return this.localStorage().setItem(this.name+"-"+e.id,JSON.stringify(e)),t.include(this.records,""+e.id)||this.records.push(""+e.id),this.save(),e.toJSON()},find:function(t){return JSON.parse(this.localStorage().getItem(this.name+"-"+t.id))},findAll:function(){return t(this.records).chain().map(function(t){return JSON.parse(this.localStorage().getItem(this.name+"-"+t))},this).compact().value()},destroy:function(e){return this.localStorage().removeItem(this.name+"-"+e.id),this.records=t.reject(this.records,function(t){return t==""+e.id}),this.save(),e},localStorage:function(){return localStorage}}),e.LocalStorage.sync=window.Store.sync=e.localSync=function(t,e,n){var i,o=e.localStorage||e.collection.localStorage,r=$.Deferred&&$.Deferred();switch(t){case"read":i=void 0!=e.id?o.find(e):o.findAll();break;case"create":i=o.create(e);break;case"update":i=o.update(e);break;case"delete":i=o.destroy(e)}return i?(n&&n.success&&n.success(i),r&&r.resolve()):(n&&n.error&&n.error("Record not found"),r&&r.reject()),r&&r.promise()},e.ajaxSync=e.sync,e.getSyncMethod=function(t){return t.localStorage||t.collection&&t.collection.localStorage?e.localSync:e.ajaxSync},e.sync=function(t,n,i){return e.getSyncMethod(n).apply(this,[t,n,i])}})(_,Backbone);